<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø­Ø±ÙˆÙ Ù…Ø¹ Ø¹Ø¨Ø§Ø¯ÙŠ</title>
    
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@700;900&display=swap" rel="stylesheet">

    <style>
        :root { 
            --primary: #ffeb3b; --secondary: #4fc3f7; --bg-purple: #4a148c; 
            --red: #f44336; --green: #00e676; --text: #fff; 
        }

        body { 
            background-color: var(--bg-purple); color: var(--text); 
            font-family: 'Tajawal', sans-serif; margin: 0; height: 100vh; overflow: hidden; 
            display: flex; flex-direction: column; align-items: center; justify-content: center; 
        }
        
        .screen { display: none; width: 100%; height: 100%; flex-direction: column; align-items: center; position: absolute; top: 0; left: 0; z-index: 1; }
        .active { display: flex; }

        /* Ø§Ù„Ø´Ø§Ø´Ø© Ø§Ù„Ø£ÙˆÙ„Ù‰ */
        #scr-setup {
            background-image: url('47267.jpg'); background-size: cover; background-position: center; background-repeat: no-repeat;
            justify-content: flex-end; padding-bottom: 30px; 
        }

        .login-bar {
            background: rgba(74, 20, 140, 0.85); width: 90%; max-width: 1100px; padding: 15px; border-radius: 50px;
            border: 2px solid var(--primary); box-shadow: 0 -5px 20px rgba(0,0,0,0.5);
            display: flex; flex-direction: row; justify-content: center; align-items: center; gap: 15px;
        }
        .login-bar input {
            background: rgba(255,255,255,0.95); border: none; border-radius: 30px; padding: 10px 20px;
            font-size: 1.1rem; color: #4a148c; font-weight: bold; font-family: 'Tajawal'; width: 35%; text-align: center; margin: 0;
        }
        .login-bar button {
            background: var(--primary); color: #4a148c; border: none; padding: 10px 40px; font-size: 1.2rem;
            border-radius: 30px; cursor: pointer; font-weight: 900; white-space: nowrap; margin: 0;
            box-shadow: 0 4px 10px rgba(0,0,0,0.3);
        }

        /* ØªÙ†Ø³ÙŠÙ‚Ø§Øª Ø¹Ø§Ù…Ø© */
        #scr-connect, #scr-host { justify-content: center; }
        .btn-action { width: 90%; margin: 8px auto; font-size: 1.1rem; padding: 15px; display: block; border-radius: 15px; cursor: pointer; border: none; font-weight: bold; }

        .grid-container { display: grid; grid-template-columns: repeat(7, 1fr); gap: 8px; margin-top: 20px; padding: 20px; }
        .letter-box { width: 80px; height: 80px; background: #fff; color: #4a148c; border-radius: 20px; display: flex; justify-content: center; align-items: center; font-size: 2.2rem; font-weight: 900; cursor: pointer; transition: 0.3s; border: 4px solid #ddd; box-shadow: 0 5px 0 #bbb; }
        .letter-box.red { background: var(--red); color: white; border-color: #d32f2f; box-shadow: 0 5px 0 #b71c1c; }
        .letter-box.green { background: var(--green); color: white; border-color: #388e3c; box-shadow: 0 5px 0 #2e7d32; }

        .results-wrapper { display: flex; width: 100%; height: 80%; justify-content: space-around; align-items: flex-start; padding-top: 20px; overflow-y: auto; }
        .res-col { width: 45%; background: rgba(0,0,0,0.2); border-radius: 20px; padding: 20px; min-height: 50%; display: flex; flex-direction: column; align-items: center; border: 2px solid rgba(255,255,255,0.2); }
        .res-word { width: 100%; font-size: 1.3rem; padding: 10px; border-bottom: 1px solid rgba(255,255,255,0.1); display: flex; justify-content: space-between; align-items: center; }
        .res-word.approved { color: #69f0ae; font-weight: bold; }

        .team-letters-strip { display: flex; flex-wrap: wrap; gap: 5px; justify-content: center; margin-bottom: 20px; background: rgba(0,0,0,0.3); padding: 10px; border-radius: 10px; width: 100%; }
        .tiny-letter { width: 35px; height: 35px; border-radius: 50%; background: #fff; color: #4a148c; display: flex; justify-content: center; align-items: center; font-size: 1rem; font-weight: bold; }

        .mobile-view { padding: 20px; text-align: center; justify-content: flex-start; overflow-y: auto; background: #f3e5f5; color: #333; }
        #timer-box { font-size: 3.5rem; color: var(--primary); font-family: monospace; text-shadow: 2px 2px 0 #000; background: rgba(0,0,0,0.3); padding: 5px 30px; border-radius: 15px; }
        
        .qr-row { display: flex; gap: 40px; margin-bottom: 30px; }
        .qr-card { background: white; padding: 20px; border-radius: 20px; color: #4a148c; text-align: center; box-shadow: 0 10px 30px rgba(0,0,0,0.3); }
        .qr-img { width: 150px; height: 150px; display: block; }

        #question-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #4a148c; z-index: 9999; flex-direction: column; justify-content: center; align-items: center; text-align: center; padding: 20px; box-sizing: border-box; border: 10px solid var(--primary); }
        #q-char-disp { font-size: 6rem; color: var(--primary); margin-bottom: 10px; text-shadow: 0 5px 0 #000; }
        #q-text { font-size: 2.2rem; margin-bottom: 20px; color: white; line-height: 1.4; font-weight: bold; }
        #q-answer { font-size: 1.8rem; color: #fff; background: var(--green); padding: 10px 30px; border-radius: 50px; margin-top: 20px; display: none; }
        
        #buzzer-btn { width: 220px; height: 220px; border-radius: 50%; background: #f44336; color: white; font-size: 2.5rem; font-weight: bold; border: 8px solid white; box-shadow: 0 10px 20px rgba(0,0,0,0.4); margin-top: 20px; }
        
        #admin-modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(74, 20, 140, 0.95); z-index: 2000; flex-direction: column; justify-content: center; align-items: center; overflow-y: auto; padding: 20px; }
        
        .judge-btn { border: none; border-radius: 5px; padding: 5px 12px; margin-left: 5px; cursor: pointer; font-size: 1.2rem; }
        .btn-ok { background: var(--green); color: white; }
        .btn-no { background: var(--red); color: white; }
        .btn-start { background: var(--primary); color: #4a148c; border: 4px solid #fff; }

        .audio-wave { display: none; font-size: 3rem; color: var(--primary); margin-bottom: 20px; animation: pulse 1s infinite; }
        @keyframes pulse { 0% { transform: scale(1); opacity: 1; } 50% { transform: scale(1.1); opacity: 0.8; } 100% { transform: scale(1); opacity: 1; } }

        .q-select-btn { width: 100%; padding: 15px; margin: 5px 0; border: none; border-radius: 10px; color: white; font-size: 1.1rem; text-align: right; cursor: pointer; }

        .hurry-img { width: 100%; max-width: 400px; border-radius: 15px; margin-bottom: 15px; box-shadow: 0 5px 15px rgba(0,0,0,0.2); border: 2px solid var(--primary); }

        .reset-btn-corner {
            position: fixed; top: 20px; left: 20px;
            background: rgba(255, 0, 0, 0.7); color: white;
            border: none; padding: 10px 20px; border-radius: 30px;
            cursor: pointer; font-size: 1rem; font-weight: bold;
            z-index: 9999; box-shadow: 0 5px 10px rgba(0,0,0,0.5);
        }
        .reset-btn-corner:hover { background: red; }
    </style>
</head>
<body>

    <div id="scr-setup" class="screen active">
        <div class="login-bar">
            <input type="text" id="t1" placeholder="Ø§Ø³Ù… Ø§Ù„ÙØ±ÙŠÙ‚ Ø§Ù„Ø£Ø­Ù…Ø±">
            <input type="text" id="t2" placeholder="Ø§Ø³Ù… Ø§Ù„ÙØ±ÙŠÙ‚ Ø§Ù„Ø£Ø®Ø¶Ø±">
            <button onclick="createGame()">Ø§Ù†Ø·Ù„Ù‚ ğŸš€</button>
        </div>
    </div>

    <div id="scr-connect" class="screen">
        <h1 style="color:var(--primary); font-size:3rem; margin-bottom:10px;">Ø§Ù…Ø³Ø­ Ù„Ù„Ø§Ù†Ø¶Ù…Ø§Ù…</h1>
        <audio id="audio-rules" src="rules.mp3" preload="auto"></audio>
        <audio id="audio-wrong" src="wrong.mp3" preload="auto"></audio>
        
        <div id="audio-visual" class="audio-wave">ğŸ”Š Ø¬Ø§Ø±ÙŠ ØªØ´ØºÙŠÙ„ Ø§Ù„ØµÙˆØª...</div>
        <div class="qr-row">
            <div class="qr-card">
                <div id="qr-red-container"></div>
                <h2 id="qr-name-red" style="color:var(--red); margin:5px 0;">Ø§Ù„ÙØ±ÙŠÙ‚ Ø§Ù„Ø£Ø­Ù…Ø±</h2>
            </div>
            <div class="qr-card">
                <div id="qr-green-container"></div>
                <h2 id="qr-name-green" style="color:var(--green); margin:5px 0;">Ø§Ù„ÙØ±ÙŠÙ‚ Ø§Ù„Ø£Ø®Ø¶Ø±</h2>
            </div>
        </div>
        <button class="btn-start" style="font-size:1.2rem; padding:10px 30px;" onclick="startGameDisplay()">Ø§Ù„Ø§Ù†ØªÙ‚Ø§Ù„ Ù„Ù„ÙˆØ­Ø© Ø§Ù„Ø­Ø±ÙˆÙ</button>
        <div style="position: absolute; bottom: 20px; left: 20px; background: white; padding: 10px; border-radius:15px; text-align: center; box-shadow: 0 5px 15px rgba(0,0,0,0.2);">
            <div id="qr-admin-container"></div><small style="color:var(--bg-purple); font-weight:bold; display:block;">Ø§Ù„Ù…Ù‚Ø¯Ù…</small>
        </div>
    </div>

    <div id="scr-host" class="screen">
        <button class="reset-btn-corner" onclick="fullReset()">ğŸ”„ Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ù„Ø¹Ø¨Ø©</button>
        <div style="width: 100%; display: flex; justify-content: space-between; padding: 20px 50px; box-sizing: border-box; font-size: 2.5rem; font-weight: 900; text-shadow: 2px 2px 5px rgba(0,0,0,0.3);">
            <span style="color: #ff8a80" id="lbl-t1">Ø§Ù„Ø£Ø­Ù…Ø±</span>
            <div id="timer-box">00:00</div>
            <span style="color: #69f0ae" id="lbl-t2">Ø§Ù„Ø£Ø®Ø¶Ø±</span>
        </div>
        <div id="host-grid" class="grid-container"></div>
        <div id="host-waiting" style="display:none; margin-top:50px; text-align: center;">
            <h1 style="font-size: 4rem; color: var(--primary);">â³</h1>
            <h2>Ø§Ù„Ø­ÙƒÙ… ÙŠÙ‚ÙˆÙ… Ø¨Ù…Ø±Ø§Ø¬Ø¹Ø© Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø§Øª...</h2>
        </div>
        <div id="host-results" class="results-wrapper" style="display: none;">
            <div class="res-col" style="border: 4px solid var(--red)">
                <h2 id="final-t1-name" style="color: var(--red)">Ø§Ù„Ø£Ø­Ù…Ø±</h2>
                <h3 style="color:white">Ø§Ù„Ù†ØªÙŠØ¬Ø©: <span id="score-red">0</span></h3>
                <div id="res-chars-red" class="team-letters-strip"></div>
                <div id="list-red" style="width:100%"></div>
            </div>
            <div class="res-col" style="border: 4px solid var(--green)">
                <h2 id="final-t2-name" style="color: var(--green)">Ø§Ù„Ø£Ø®Ø¶Ø±</h2>
                <h3 style="color:white">Ø§Ù„Ù†ØªÙŠØ¬Ø©: <span id="score-green">0</span></h3>
                <div id="res-chars-green" class="team-letters-strip"></div>
                <div id="list-green" style="width:100%"></div>
            </div>
        </div>
    </div>

    <div id="scr-admin" class="screen mobile-view">
        <h2 style="color:var(--bg-purple)">Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… ğŸ› </h2>
        
        <div id="admin-pre-game" style="background:white; padding:15px; border-radius:15px; margin-bottom:20px;">
            <button style="background:#9c27b0; color:white; width:100%; border-radius:15px; padding:10px; margin-bottom:10px;" onclick="playAudio('rules')">ğŸ“¢ ØªØ´ØºÙŠÙ„ Ø§Ù„Ø´Ø±Ø­</button>
            <button style="background:#000; color:white; width:100%; border-radius:15px; padding:10px;" onclick="playAudio('wrong')">ğŸ‘ ØªØ£Ø«ÙŠØ± Ø§Ù„ØºÙ„Ø·</button>
        </div>

        <div id="admin-p1">
            <button style="background:#000; color:white; width:100%; border-radius:15px; padding:10px; margin-bottom:20px;" onclick="playAudio('wrong')">ğŸ‘ ØªØ´ØºÙŠÙ„ ØµÙˆØª Ø§Ù„ØºÙ„Ø·</button>
            <p>Ø§Ø¶ØºØ· Ø§Ù„Ø­Ø±Ù Ù„Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø³Ø¤Ø§Ù„:</p>
            <div id="admin-grid" class="grid-container" style="grid-template-columns: repeat(5, 1fr); zoom: 0.6;"></div>
            <button class="btn-start" onclick="setPhase(2)" style="width: 100%; margin-top: 20px;">Ø§Ù„Ø§Ù†ØªÙ‚Ø§Ù„ Ù„Ù…Ø±Ø­Ù„Ø© Ø§Ù„ÙƒÙ„Ù…Ø§Øª</button>
        </div>

        <div id="admin-p2" style="display: none;">
            <h3>Ø§Ù„Ù…Ø±Ø­Ù„Ø© 2: Ø§Ù„ÙƒÙ„Ù…Ø§Øª</h3>
            <div style="background: white; padding: 15px; border-radius: 15px; margin-bottom: 20px;">
                <label>Ø§Ù„ÙˆÙ‚Øª (Ø¯Ù‚Ø§Ø¦Ù‚):</label>
                <input type="number" id="custom-timer-input" value="2" style="width: 60px; border:1px solid #ccc;">
                <button style="background: orange; border-radius:10px; padding:5px 15px; font-size:1rem;" onclick="startTimer()">Ø§Ø¨Ø¯Ø£</button>
            </div>
            <button style="background: var(--red); width: 90%; padding:15px; border-radius:10px; color:white;" onclick="stopTimer()">Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„ÙˆÙ‚Øª (Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„ØªØ³Ø¬ÙŠÙ„)</button>
        </div>

        <div id="admin-p3" style="display: none;">
            <h3>ğŸ§ Ø§Ù„ØªØ­ÙƒÙŠÙ…</h3>
            <div style="border: 2px solid var(--red); background:white; padding:10px; margin-bottom:10px; border-radius:10px;">
                <h4 id="adm-rev-t1" style="color:var(--red); margin:0;">Ø§Ù„Ø£Ø­Ù…Ø±:</h4>
                <div id="review-chars-red" class="team-letters-strip"></div>
                <div id="review-list-red"></div>
            </div>
            <div style="border: 2px solid var(--green); background:white; padding:10px; margin-bottom:10px; border-radius:10px;">
                <h4 id="adm-rev-t2" style="color:var(--green); margin:0;">Ø§Ù„Ø£Ø®Ø¶Ø±:</h4>
                <div id="review-chars-green" class="team-letters-strip"></div>
                <div id="review-list-green"></div>
            </div>
            <button style="background: var(--secondary); color:white; width: 100%; padding:15px; border-radius:10px;" onclick="publishResults()">ğŸ“º Ù†Ø´Ø± Ø§Ù„Ù†ØªØ§Ø¦Ø¬</button>
        </div>
    </div>

    <div id="scr-player" class="screen mobile-view">
        <h2 id="p-team-name">ÙØ±ÙŠÙ‚ÙŠ</h2>
        <div id="p-p1">
            <h3>Ø­Ø±ÙˆÙÙ†Ø§:</h3>
            <div id="p-letters" class="team-letters-strip" style="background:white;"></div>
            <p style="color:#666;">Ø§Ù†ØªØ¸Ø± Ø§Ù„Ø³Ø¤Ø§Ù„...</p>
        </div>
        <div id="p-p2" style="display: none;">
            <img src="hurry.jpg" class="hurry-img" alt="Ø§Ø®Ù„ØµÙˆØ§ Ø¨Ø³Ø±Ø¹Ø©">
            <h3>Ø£ÙƒØªØ¨ ÙƒÙ„Ù…Ø§ØªÙƒ:</h3>
            <div id="p-letters-2" class="team-letters-strip" style="background:white;"></div>
            <input type="text" id="word-in" placeholder="ÙƒÙ„Ù…Ø©...">
            <button class="btn-start" onclick="sendWord()">Ø¥Ø±Ø³Ø§Ù„</button>
            <p id="sent-msg" style="color: var(--green); margin-top:10px;"></p>
        </div>
        <div id="p-p3" style="display: none;">
            <h2>Ø§Ù†ØªÙ‡Ù‰ Ø§Ù„ÙˆÙ‚Øª ğŸ›‘</h2>
            <p>Ø§Ù„Ø­ÙƒÙ… ÙŠØ±Ø§Ø¬Ø¹ Ø§Ù„Ù†ØªØ§Ø¦Ø¬...</p>
        </div>
    </div>

    <div id="question-overlay">
        <div id="q-char-disp"></div>
        <div id="q-text">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø³Ø¤Ø§Ù„...</div>
        <div id="player-buzzer-area" style="display:none;">
            <button id="buzzer-btn" onclick="hitBuzzer()">ğŸš€ Ø§Ø¶ØºØ·!</button>
            <h2 id="buzzer-msg" style="color:white; margin-top:20px;"></h2>
        </div>
        <div id="admin-buzzer-status" style="display:none; color:yellow; font-size:2rem; font-weight:bold; margin:20px 0;">Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„Ø¬Ø±Ø³...</div>
        <div id="q-answer">Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø©: ...</div>
        <div id="admin-overlay-controls" style="display:none; margin-top:20px; background:rgba(0,0,0,0.3); padding:10px; border-radius:15px;">
            <button class="btn-action" style="background: #fff; color:#333; font-size:0.9rem;" onclick="resetBuzzer()">ğŸ”„ ÙØªØ­ Ø§Ù„Ø¬Ø±Ø³ Ù…Ø¬Ø¯Ø¯Ø§Ù‹</button>
            <div style="display:flex; gap:5px; margin-top:10px; justify-content:center;">
                <button class="btn-action" style="background: orange; color: black; width:auto;" onclick="toggleAnswer()">ğŸ‘ Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø©</button>
                <button class="btn-action" style="background: var(--red); color: white; width:auto;" onclick="hideQuestionAndReturn()">ğŸ”™ Ø¥Ù†Ù‡Ø§Ø¡</button>
            </div>
        </div>
    </div>

    <div id="admin-modal">
        <h1 id="adm-modal-char" style="font-size: 4rem; color: white;"></h1>
        <div id="admin-q-selection" style="width:100%; margin-bottom:20px;"></div>
        <hr style="width:80%; border-color:#fff; margin:20px 0;">
        <h3 style="color:#fff; margin:0;">Ù…Ù† Ø§Ù„ÙØ§Ø¦Ø² Ø¨Ø§Ù„Ø­Ø±ÙØŸ</h3>
        <div style="display:flex; justify-content:center; width:100%;">
            <button id="btn-win-red" class="btn-action" style="background: var(--red); color: white; width:45%;" onclick="colorChar('red')">Ø§Ù„Ø£Ø­Ù…Ø±</button>
            <button id="btn-win-green" class="btn-action" style="background: var(--green); color: white; width:45%;" onclick="colorChar('green')">Ø§Ù„Ø£Ø®Ø¶Ø±</button>
        </div>
        <button class="btn-action" style="background: #fff; color: #333; margin-top:20px;" onclick="closeAdminModal()">Ø¥Ù„ØºØ§Ø¡</button>
    </div>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyDh4v9gRCICA_XRCJXsDpbtCySYAoFsfhk",
            authDomain: "bagera-word.firebaseapp.com",
            databaseURL: "https://bagera-word-default-rtdb.firebaseio.com",
            projectId: "bagera-word",
            storageBucket: "bagera-word.firebasestorage.app",
            messagingSenderId: "53001885470",
            appId: "1:53001885470:web:c6649f9f259824f747db0f"
        };
        try { if(firebase.apps.length === 0) firebase.initializeApp(firebaseConfig); else firebase.app(); } catch(e) {}
        const db = firebase.database();

        // Ù…ØªØºÙŠØ±Ø§Øª Ø¹Ø§Ù„Ù…ÙŠØ© Ù„ØªØ®Ø²ÙŠÙ† Ø£Ø³Ù…Ø§Ø¡ Ø§Ù„ÙØ±Ù‚
        let team1Name = "Ø§Ù„ÙØ±ÙŠÙ‚ Ø§Ù„Ø£Ø­Ù…Ø±";
        let team2Name = "Ø§Ù„ÙØ±ÙŠÙ‚ Ø§Ù„Ø£Ø®Ø¶Ø±";

        const questionsDB = {
            "Ø£": {easy: {q:"Ø­ÙŠÙˆØ§Ù† Ù…ÙØªØ±Ø³ ÙŠÙ„Ù‚Ø¨ Ø¨Ù…Ù„Ùƒ Ø§Ù„ØºØ§Ø¨Ø©ØŸ", a:"Ø£Ø³Ø¯"}, medium: {q:"Ù…Ø§ Ù‡ÙŠ Ø£ÙƒØ¨Ø± Ù‚Ø§Ø±Ø§Øª Ø§Ù„Ø¹Ø§Ù„Ù…ØŸ", a:"Ø¢Ø³ÙŠØ§"}, hard: {q:"ØµÙˆØª Ø§Ø´ØªØ¹Ø§Ù„ Ø§Ù„Ù†Ø§Ø± ÙˆØªÙˆÙ‡Ø¬Ù‡Ø§ØŸ", a:"Ø£Ø¬ÙŠØ¬"}},
            "Ø¨": {easy: {q:"Ø·Ø§Ø¦Ø± Ù…Ø§Ø¦ÙŠ Ù„Ø§ ÙŠØ·ÙŠØ±ØŸ", a:"Ø¨Ø·Ø±ÙŠÙ‚"}, medium: {q:"Ø¹Ø§ØµÙ…Ø© Ø§Ù„Ø¹Ø±Ø§Ù‚ØŸ", a:"Ø¨ØºØ¯Ø§Ø¯"}, hard: {q:"Ù…Ø±Ø¶ Ø¬Ù„Ø¯ÙŠ ÙŠØ³Ø¨Ø¨ Ø¨Ù‚Ø¹ Ø¨ÙŠØ¶Ø§Ø¡ØŸ", a:"Ø¨Ù‡Ø§Ù‚"}},
            "Øª": {easy: {q:"ÙØ§ÙƒÙ‡Ø© ØµÙŠÙÙŠØ© Ø°ÙƒØ±Øª ÙÙŠ Ø§Ù„Ù‚Ø±Ø¢Ù†ØŸ", a:"ØªÙŠÙ†"}, medium: {q:"Ø¯ÙˆÙ„Ø© Ø¹Ø§ØµÙ…ØªÙ‡Ø§ Ø¨Ø§Ù†ÙƒÙˆÙƒØŸ", a:"ØªØ§ÙŠÙ„Ø§Ù†Ø¯"}, hard: {q:"Ø¯ÙˆØ§Ø¡ Ù„Ø¥Ø¨Ø·Ø§Ù„ Ø§Ù„Ø³Ù…ØŸ", a:"ØªØ±ÙŠØ§Ù‚"}},
            "Ø«": {easy: {q:"Ø­ÙŠÙˆØ§Ù† Ù…Ø´Ù‡ÙˆØ± Ø¨Ø§Ù„Ù…ÙƒØ±ØŸ", a:"Ø«Ø¹Ù„Ø¨"}, medium: {q:"ØºØ§Ø² Ø§Ù„Ø²ÙÙŠØ±ØŸ", a:"Ø«Ø§Ù†ÙŠ Ø£ÙƒØ³ÙŠØ¯ Ø§Ù„ÙƒØ±Ø¨ÙˆÙ†"}, hard: {q:"Ù…Ø¹Ø¯Ù† ÙƒÙŠÙ…ÙŠØ§Ø¦ÙŠ (Th)ØŸ", a:"Ø«ÙˆØ±ÙŠÙˆÙ…"}},
            "Ø¬": {easy: {q:"Ø³ÙÙŠÙ†Ø© Ø§Ù„ØµØ­Ø±Ø§Ø¡ØŸ", a:"Ø¬Ù…Ù„"}, medium: {q:"Ø§Ù„Ø¬Ø¨Ù„ Ø§Ù„Ø°ÙŠ Ø±Ø³Øª Ø¹Ù„ÙŠÙ‡ Ø³ÙÙŠÙ†Ø© Ù†ÙˆØ­ØŸ", a:"Ø¬ÙˆØ¯ÙŠ"}, hard: {q:"Ø¹Ù„Ù… Ø·Ø¨Ù‚Ø§Øª Ø§Ù„Ø£Ø±Ø¶ØŸ", a:"Ø¬ÙŠÙˆÙ„ÙˆØ¬ÙŠØ§"}},
            "Ø­": {easy: {q:"Ø³Ø§Ø¦Ù„ Ø£Ø¨ÙŠØ¶ Ù…ÙÙŠØ¯ Ù„Ù„Ø¹Ø¸Ø§Ù…ØŸ", a:"Ø­Ù„ÙŠØ¨"}, medium: {q:"ÙƒØ§Ø¦Ù† ÙŠØºÙŠØ± Ù„ÙˆÙ†Ù‡ØŸ", a:"Ø­Ø±Ø¨Ø§Ø¡"}, hard: {q:"ØµÙˆØª Ø­Ø±ÙƒØ© Ø£ÙˆØ±Ø§Ù‚ Ø§Ù„Ø´Ø¬Ø±ØŸ", a:"Ø­ÙÙŠÙ"}},
            "Ø®": {easy: {q:"Ø®Ø¶Ø§Ø± Ø£Ø®Ø¶Ø± Ù„Ù„Ø³Ù„Ø·Ø©ØŸ", a:"Ø®ÙŠØ§Ø±"}, medium: {q:"Ø¹Ø§ØµÙ…Ø© Ø§Ù„Ø³ÙˆØ¯Ø§Ù†ØŸ", a:"Ø®Ø±Ø·ÙˆÙ…"}, hard: {q:"ØµÙˆØª ØªØ¯ÙÙ‚ Ø§Ù„Ù…ÙŠØ§Ù‡ØŸ", a:"Ø®Ø±ÙŠØ±"}},
            "Ø¯": {easy: {q:"Ø·Ø§Ø¦Ø± ÙŠÙˆÙ‚Ø¸Ù†Ø§ Ù„Ù„ÙØ¬Ø±ØŸ", a:"Ø¯ÙŠÙƒ"}, medium: {q:"Ø¹Ø§ØµÙ…Ø© Ø³ÙˆØ±ÙŠØ§ØŸ", a:"Ø¯Ù…Ø´Ù‚"}, hard: {q:"ØµÙˆØª Ù…Ø´ÙŠ Ø§Ù„Ù†Ù…Ù„ØŸ", a:"Ø¯Ø¨ÙŠØ¨"}},
            "Ø°": {easy: {q:"Ø¬Ø²Ø¡ Ø®Ù„ÙÙŠ Ù„Ù„Ø­ÙŠÙˆØ§Ù†Ø§ØªØŸ", a:"Ø°ÙŠÙ„"}, medium: {q:"Ù…Ø¹Ø¯Ù† Ø£ØµÙØ± Ø«Ù…ÙŠÙ†ØŸ", a:"Ø°Ù‡Ø¨"}, hard: {q:"Ø£Ø¹Ù„Ù‰ Ø§Ù„Ø´ÙŠØ¡ Ø£Ùˆ Ø³Ù†Ø§Ù… Ø§Ù„Ø¬Ù…Ù„ØŸ", a:"Ø°Ø±ÙˆØ©"}},
            "Ø±": {easy: {q:"ÙØ§ÙƒÙ‡Ø© Ø¨Ø­Ø¨ÙˆØ¨ Ø­Ù…Ø±Ø§Ø¡ØŸ", a:"Ø±Ù…Ø§Ù†"}, medium: {q:"Ø´Ù‡Ø± Ø§Ù„ØµÙŠØ§Ù…ØŸ", a:"Ø±Ù…Ø¶Ø§Ù†"}, hard: {q:"Ø§Ù„Ø¹Ø¸Ø§Ù… Ø§Ù„Ø¨Ø§Ù„ÙŠØ©ØŸ", a:"Ø±Ù…ÙŠÙ…"}},
            "Ø²": {easy: {q:"Ø­ÙŠÙˆØ§Ù† Ø·ÙˆÙŠÙ„ Ø§Ù„Ø±Ù‚Ø¨Ø©ØŸ", a:"Ø²Ø±Ø§ÙØ©"}, medium: {q:"ÙƒÙˆÙƒØ¨ Ø°Ùˆ Ø­Ù„Ù‚Ø§ØªØŸ", a:"Ø²Ø­Ù„"}, hard: {q:"Ø§Ù„Ø¨Ø±Ø¯ Ø§Ù„Ø´Ø¯ÙŠØ¯ØŸ", a:"Ø²Ù…Ù‡Ø±ÙŠØ±"}},
            "Ø³": {easy: {q:"ÙˆØ³ÙŠÙ„Ø© Ù…ÙˆØ§ØµÙ„Ø§Øª Ø¨Ù€ 4 Ø¹Ø¬Ù„Ø§ØªØŸ", a:"Ø³ÙŠØ§Ø±Ø©"}, medium: {q:"Ø³ÙˆØ±Ø© ØªØ¹Ø¯Ù„ Ø«Ù„Ø« Ø§Ù„Ù‚Ø±Ø¢Ù†ØŸ", a:"Ø§Ù„Ø¥Ø®Ù„Ø§Øµ"}, hard: {q:"Ø§Ù„ØºØ¨Ø§Ø± Ø§Ù„ÙƒÙˆÙ†ÙŠØŸ", a:"Ø³Ø¯ÙŠÙ…"}},
            "Ø´": {easy: {q:"Ù†Ø¬Ù… ÙŠØ¶ÙŠØ¡ Ø§Ù„Ø£Ø±Ø¶ØŸ", a:"Ø´Ù…Ø³"}, medium: {q:"Ø´Ù‡Ø± ÙŠÙ„ÙŠ Ø±Ù…Ø¶Ø§Ù†ØŸ", a:"Ø´ÙˆØ§Ù„"}, hard: {q:"Ø§Ù„Ø±Ø§Ø¦Ø­Ø© Ø§Ù„Ø·ÙŠØ¨Ø©ØŸ", a:"Ø´Ø°Ù‰"}},
            "Øµ": {easy: {q:"Ø§Ù„Ø±ÙƒÙ† Ø§Ù„Ø«Ø§Ù†ÙŠ Ù„Ù„Ø¥Ø³Ù„Ø§Ù…ØŸ", a:"ØµÙ„Ø§Ø©"}, medium: {q:"Ø·Ø§Ø¦Ø± Ø­Ø§Ø¯ Ø§Ù„Ø¨ØµØ±ØŸ", a:"ØµÙ‚Ø±"}, hard: {q:"Ø§Ø³Ù… Ù„Ù„Ø³ÙŠÙ Ø§Ù„Ù‚Ø§Ø·Ø¹ØŸ", a:"ØµØ§Ø±Ù…"}},
            "Ø¶": {easy: {q:"Ø­ÙŠÙˆØ§Ù† ÙŠØ±Ù…Ø² Ù„Ù‡ Ø¨Ø§Ù„Ù‚ÙØ²ØŸ", a:"Ø¶ÙØ¯Ø¹"}, medium: {q:"ÙˆÙ‚Øª Ø§Ø´ØªØ¯Ø§Ø¯ Ø§Ù„Ø­Ø±Ø§Ø±Ø©ØŸ", a:"Ø¶Ø­Ù‰"}, hard: {q:"Ù…Ù† Ø£Ø³Ù…Ø§Ø¡ Ø§Ù„Ø£Ø³Ø¯ØŸ", a:"Ø¶Ø±ØºØ§Ù…"}},
            "Ø·": {easy: {q:"ÙˆØ³ÙŠÙ„Ø© Ù†Ù‚Ù„ Ø¬ÙˆÙŠØ©ØŸ", a:"Ø·Ø§Ø¦Ø±Ø©"}, medium: {q:"Ø¹Ø§ØµÙ…Ø© Ø§Ù„ÙŠØ§Ø¨Ø§Ù†ØŸ", a:"Ø·ÙˆÙƒÙŠÙˆ"}, hard: {q:"Ø§Ù„Ø¬Ø¨Ù„ Ø§Ù„Ø¹Ø¸ÙŠÙ…ØŸ", a:"Ø·ÙˆØ¯"}},
            "Ø¸": {easy: {q:"Ø¬Ø²Ø¡ ØµÙ„Ø¨ Ø¨Ø£Ø·Ø±Ø§Ù Ø§Ù„Ø£ØµØ§Ø¨Ø¹ØŸ", a:"Ø¸ÙØ±"}, medium: {q:"Ø­ÙŠÙˆØ§Ù† ÙŠØ´Ø¨Ù‡ Ø§Ù„ØºØ²Ø§Ù„ØŸ", a:"Ø¸Ø¨ÙŠ"}, hard: {q:"Ø§Ù„Ù…Ø±Ø£Ø© ÙÙŠ Ø§Ù„Ù‡ÙˆØ¯Ø¬ØŸ", a:"Ø¸Ø¹ÙŠÙ†Ø©"}},
            "Ø¹": {easy: {q:"Ø¹Ø¶Ùˆ Ø§Ù„Ø¥Ø¨ØµØ§Ø±ØŸ", a:"Ø¹ÙŠÙ†"}, medium: {q:"Ø¹Ø§ØµÙ…Ø© Ø§Ù„Ø£Ø±Ø¯Ù†ØŸ", a:"Ø¹Ù…Ø§Ù†"}, hard: {q:"Ø§Ø³Ù… Ù„Ù„Ø°Ù‡Ø¨ØŸ", a:"Ø¹Ø³Ø¬Ø¯"}},
            "Øº": {easy: {q:"Ø­ÙŠÙˆØ§Ù† Ø¨Ø¹ÙŠÙˆÙ† ÙˆØ§Ø³Ø¹Ø©ØŸ", a:"ØºØ²Ø§Ù„"}, medium: {q:"Ø·Ø§Ø¦Ø± Ù‚Ø§Ø¨ÙŠÙ„ ÙˆÙ‡Ø§Ø¨ÙŠÙ„ØŸ", a:"ØºØ±Ø§Ø¨"}, hard: {q:"Ù…Ù† Ø£Ø³Ù…Ø§Ø¡ Ø§Ù„Ø£Ø³Ø¯ØŸ", a:"ØºØ¶Ù†ÙØ±"}},
            "Ù": {easy: {q:"Ø­ÙŠÙˆØ§Ù† Ø¨Ø®Ø±Ø·ÙˆÙ…ØŸ", a:"ÙÙŠÙ„"}, medium: {q:"Ø³ÙˆØ±Ø© Ø§Ù„Ù…Ø§Ù†Ø¹Ø©ØŸ", a:"Ø§Ù„ÙØ§ØªØ­Ø©"}, hard: {q:"ØµÙˆØª Ø§Ù„Ø£ÙØ¹Ù‰ØŸ", a:"ÙØ­ÙŠØ­"}},
            "Ù‚": {easy: {q:"Ù†ÙƒØªØ¨ Ø¨Ù‡ØŸ", a:"Ù‚Ù„Ù…"}, medium: {q:"Ø§ØªØ¬Ø§Ù‡ Ø§Ù„ØµÙ„Ø§Ø©ØŸ", a:"Ù‚Ø¨Ù„Ø©"}, hard: {q:"Ø§Ø³Ù… Ù„Ù„Ø£Ø³Ø¯ ÙÙŠ Ø§Ù„Ù‚Ø±Ø¢Ù†ØŸ", a:"Ù‚Ø³ÙˆØ±Ø©"}},
            "Ùƒ": {easy: {q:"Ø­ÙŠÙˆØ§Ù† ÙˆÙÙŠØŸ", a:"ÙƒÙ„Ø¨"}, medium: {q:"Ø¨Ù†Ø§Ø¡ Ù…ÙƒØ¹Ø¨ Ø¨Ù…ÙƒØ©ØŸ", a:"ÙƒØ¹Ø¨Ø©"}, hard: {q:"Ø§Ù„Ù†ÙˆÙ… Ø§Ù„Ø®ÙÙŠÙØŸ", a:"ÙƒØ±Ù‰"}},
            "Ù„": {easy: {q:"Ø­Ù…Ø¶ÙŠØ§Øª ØµÙØ±Ø§Ø¡ØŸ", a:"Ù„ÙŠÙ…ÙˆÙ†"}, medium: {q:"Ø¯ÙˆÙ„Ø© Ø¹Ø§ØµÙ…ØªÙ‡Ø§ Ø¨ÙŠØ±ÙˆØªØŸ", a:"Ù„Ø¨Ù†Ø§Ù†"}, hard: {q:"Ù…ÙˆØ¬ Ø§Ù„Ø¨Ø­Ø± Ø§Ù„ØµØ§Ø®Ø¨ØŸ", a:"Ù„Ø¬Ø©"}},
            "Ù…": {easy: {q:"ÙØ§ÙƒÙ‡Ø© ÙŠØ­Ø¨Ù‡Ø§ Ø§Ù„Ù‚Ø±Ø¯ØŸ", a:"Ù…ÙˆØ²"}, medium: {q:"Ù…Ø¯ÙŠÙ†Ø© Ù…ÙˆÙ„Ø¯ Ø§Ù„Ù†Ø¨ÙŠØŸ", a:"Ù…ÙƒØ©"}, hard: {q:"Ø§Ù„Ø³ÙŠÙ Ø§Ù„Ù‡Ù†Ø¯ÙŠØŸ", a:"Ù…Ù‡Ù†Ø¯"}},
            "Ù†": {easy: {q:"Ø­Ø´Ø±Ø© Ù†Ø´ÙŠØ·Ø©ØŸ", a:"Ù†Ù…Ù„Ø©"}, medium: {q:"Ø­ÙŠÙˆØ§Ù† Ù…Ø®Ø·Ø·ØŸ", a:"Ù†Ù…Ø±"}, hard: {q:"Ø§Ù„Ø°Ù‡Ø¨ ÙˆØ§Ù„ÙØ¶Ø© Ù…Ø¹Ø§Ù‹ØŸ", a:"Ù†Ù‚Ø¯Ø§Ù†"}},
            "Ù‡": {easy: {q:"Ø´ÙƒÙ„ Ø§Ù„Ù‚Ù…Ø± Ø£ÙˆÙ„ Ø§Ù„Ø´Ù‡Ø±ØŸ", a:"Ù‡Ù„Ø§Ù„"}, medium: {q:"Ø·Ø§Ø¦Ø± Ø³Ù„ÙŠÙ…Ø§Ù†ØŸ", a:"Ù‡Ø¯Ù‡Ø¯"}, hard: {q:"ØµÙˆØª Ø§Ù„Ø±Ø¹Ø¯ØŸ", a:"Ù‡Ø²ÙŠÙ…"}},
            "Ùˆ": {easy: {q:"Ù†Ø¨Ø§Øª Ù†Ù‡Ø¯ÙŠ Ø¨Ù‡ØŸ", a:"ÙˆØ±Ø¯"}, medium: {q:"Ø·Ø§Ø¦Ø± ÙŠÙ†Ø§Ù… Ù…Ù‚Ù„ÙˆØ¨Ø§Ù‹ØŸ", a:"ÙˆØ·ÙˆØ§Ø·"}, hard: {q:"Ø§Ù„Ù…Ø·Ø± Ø§Ù„ØºØ²ÙŠØ±ØŸ", a:"ÙˆØ§Ø¨Ù„"}},
            "ÙŠ": {easy: {q:"Ø¹Ø¶Ùˆ Ù†Ø£ÙƒÙ„ Ø¨Ù‡ØŸ", a:"ÙŠØ¯"}, medium: {q:"Ù†Ø¨ÙŠ Ø§Ù„Ø­ÙˆØªØŸ", a:"ÙŠÙˆÙ†Ø³"}, hard: {q:"Ø§Ø³Ù… Ù„Ù„Ø¨Ø­Ø±ØŸ", a:"ÙŠÙ…"}}
        };

        const alphabet = "Ø£Ø¨ØªØ«Ø¬Ø­Ø®Ø¯Ø°Ø±Ø²Ø³Ø´ØµØ¶Ø·Ø¸Ø¹ØºÙÙ‚ÙƒÙ„Ù…Ù†Ù‡ÙˆÙŠ";
        const urlParams = new URLSearchParams(window.location.search);
        let roomId = urlParams.get('room');
        let role = urlParams.get('role');
        let selIdx = null; 

        window.onload = function() {
            if(role) { if(role === 'admin') initAdmin(); else initPlayer(); }
            else if(roomId) {
                document.getElementById('scr-setup').classList.remove('active');
                document.getElementById('scr-connect').classList.add('active');
                generateSafeQRs();
                listenForAudioActions();
            }
        };

        function fullReset() {
            if(confirm("ØªØ­Ø°ÙŠØ±: Ø³ÙŠØªÙ… Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ù„Ø¹Ø¨Ø© Ø¨Ø§Ù„ÙƒØ§Ù…Ù„ ÙˆØ·Ø±Ø¯ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù„Ø§Ø¹Ø¨ÙŠÙ†. Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ØŸ")) {
                db.ref(`games/${roomId}`).set({ state: 'reset' });
            }
        }

        function playAudio(type) {
            if(confirm("Ù‡Ù„ ØªØ±ÙŠØ¯ ØªØ´ØºÙŠÙ„ Ø§Ù„ØµÙˆØª ÙÙŠ Ø§Ù„Ø´Ø§Ø´Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©ØŸ")) {
                db.ref(`games/${roomId}/action`).set({ type: type, ts: Date.now() });
            }
        }

        function listenForAudioActions() {
            db.ref(`games/${roomId}/action`).on('value', snap => {
                const act = snap.val();
                if(act && (Date.now() - act.ts < 5000)) {
                    document.getElementById('audio-visual').style.display = 'block';
                    let audioId = act.type === 'wrong' ? 'audio-wrong' : 'audio-rules';
                    const audio = document.getElementById(audioId);
                    audio.currentTime = 0;
                    audio.play().catch(e => alert("Ø§Ù†Ù‚Ø± Ù„ØªÙØ¹ÙŠÙ„ Ø§Ù„ØµÙˆØª"));
                    audio.onended = () => document.getElementById('audio-visual').style.display = 'none';
                }
            });
        }

        function generateSafeQRs() {
            const baseUrl = window.location.href.split('?')[0];
            const size = "150x150";
            document.getElementById('qr-red-container').innerHTML = `<img class="qr-img" src="https://api.qrserver.com/v1/create-qr-code/?size=${size}&data=${encodeURIComponent(baseUrl + `?room=${roomId}&role=red`)}" />`;
            document.getElementById('qr-green-container').innerHTML = `<img class="qr-img" src="https://api.qrserver.com/v1/create-qr-code/?size=${size}&data=${encodeURIComponent(baseUrl + `?room=${roomId}&role=green`)}" />`;
            document.getElementById('qr-admin-container').innerHTML = `<img class="qr-img" style="width:70px;height:70px;" src="https://api.qrserver.com/v1/create-qr-code/?size=100x100&data=${encodeURIComponent(baseUrl + `?room=${roomId}&role=admin`)}" />`;
        }

        function createGame() {
            roomId = Math.random().toString(36).substr(2, 6);
            const t1 = document.getElementById('t1').value || "Ø§Ù„ÙØ±ÙŠÙ‚ Ø§Ù„Ø£Ø­Ù…Ø±";
            const t2 = document.getElementById('t2').value || "Ø§Ù„ÙØ±ÙŠÙ‚ Ø§Ù„Ø£Ø®Ø¶Ø±";
            
            // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø£Ø³Ù…Ø§Ø¡ ØªØ­Øª Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯ ÙÙˆØ±Ø§Ù‹
            document.getElementById('qr-name-red').innerText = t1;
            document.getElementById('qr-name-green').innerText = t2;

            let lets = alphabet.split('').sort(() => Math.random() - 0.5).slice(0, 28);
            db.ref(`games/${roomId}`).set({ t1: t1, t2: t2, letters: lets, colors: {}, state: 1, timer: 0, activeQ: null })
              .then(() => {
                  const newUrl = window.location.href.split('?')[0] + `?room=${roomId}`;
                  window.history.pushState({path:newUrl}, '', newUrl);
                  document.getElementById('scr-setup').classList.remove('active');
                  document.getElementById('scr-connect').classList.add('active');
                  generateSafeQRs();
                  listenForAudioActions();
              });
        }

        function startGameDisplay() {
            document.getElementById('scr-connect').classList.remove('active');
            document.getElementById('scr-host').classList.add('active');
            db.ref(`games/${roomId}`).on('value', s => {
                const d = s.val(); if(!d) return;
                
                if(d.state === 'reset') { window.location.href = window.location.pathname; return; }

                document.getElementById('lbl-t1').innerText = d.t1;
                document.getElementById('lbl-t2').innerText = d.t2;
                document.getElementById('final-t1-name').innerText = d.t1;
                document.getElementById('final-t2-name').innerText = d.t2;

                if(d.timer > 0) {
                    let m = Math.floor(d.timer/60); let sec = d.timer%60;
                    document.getElementById('timer-box').innerText = `${m}:${sec<10?'0'+sec:sec}`;
                } else {
                    document.getElementById('timer-box').innerText = d.timer === -1 ? "Ø§Ù†ØªÙ‡Ù‰ Ø§Ù„ÙˆÙ‚Øª" : "00:00";
                    if(d.timer === -1) document.getElementById('timer-box').style.color = "red";
                }
                const grid = document.getElementById('host-grid');
                const waiting = document.getElementById('host-waiting');
                const results = document.getElementById('host-results');
                if(d.state === 1 || d.state === 2) {
                    grid.style.display = 'grid'; waiting.style.display = 'none'; results.style.display = 'none';
                    grid.innerHTML = '';
                    d.letters.forEach((l, i) => {
                        const div = document.createElement('div'); div.className = `letter-box ${d.colors?.[i] || ''}`; div.innerText = l;
                        grid.appendChild(div);
                    });
                } else if (d.state === 3) {
                    grid.style.display = 'none'; waiting.style.display = 'block'; results.style.display = 'none';
                } else if (d.state === 4) {
                    grid.style.display = 'none'; waiting.style.display = 'none'; results.style.display = 'flex';
                    renderFinalResults(d);
                }
            });
        }

        function renderFinalResults(d) {
            const rChars = document.getElementById('res-chars-red'); const gChars = document.getElementById('res-chars-green');
            rChars.innerHTML = ''; gChars.innerHTML = '';
            d.letters.forEach((l, i) => {
                if(d.colors?.[i] === 'red') rChars.innerHTML += `<div class="tiny-letter">${l}</div>`;
                if(d.colors?.[i] === 'green') gChars.innerHTML += `<div class="tiny-letter">${l}</div>`;
            });
            const rList = document.getElementById('list-red'); const gList = document.getElementById('list-green');
            rList.innerHTML = ''; gList.innerHTML = '';
            let rScore = 0; if(d.words && d.words.red) Object.values(d.words.red).forEach(wObj => { if(wObj.status === 'ok') { rList.innerHTML += `<div class="res-word approved"><span>${wObj.text}</span><span>âœ…</span></div>`; rScore++; } });
            let gScore = 0; if(d.words && d.words.green) Object.values(d.words.green).forEach(wObj => { if(wObj.status === 'ok') { gList.innerHTML += `<div class="res-word approved"><span>${wObj.text}</span><span>âœ…</span></div>`; gScore++; } });
            document.getElementById('score-red').innerText = rScore; document.getElementById('score-green').innerText = gScore;
        }

        function monitorQuestion() {
            db.ref(`games/${roomId}/activeQ`).on('value', snap => {
                const q = snap.val();
                const overlay = document.getElementById('question-overlay');
                if(q && q.visible) {
                    overlay.style.display = 'flex';
                    if(role === 'admin') {
                        document.getElementById('q-char-disp').innerText = q.char;
                        document.getElementById('q-text').innerText = q.text;
                        document.getElementById('admin-overlay-controls').style.display = 'block';
                        document.getElementById('player-buzzer-area').style.display = 'none';
                        document.getElementById('admin-buzzer-status').style.display = 'block';
                        if(q.buzzer) {
                            const teamName = q.buzzer === 'red' ? team1Name : team2Name;
                            const teamColor = q.buzzer === 'red' ? "red" : "#2ed573";
                            document.getElementById('admin-buzzer-status').innerHTML = `ğŸ”´ Ù‚Ø§Ù… Ø¨Ø§Ù„Ø¶ØºØ·: <span style="color:${teamColor}">${teamName}</span>`;
                        } else {
                            document.getElementById('admin-buzzer-status').innerText = "ÙÙŠ Ø§Ù†ØªØ¸Ø§Ø± Ø¶ØºØ· Ø§Ù„Ø¬Ø±Ø³...";
                        }
                        if(q.showAns) {
                            document.getElementById('q-answer').style.display = 'block';
                            document.getElementById('q-answer').innerText = "Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø©: " + q.answer;
                        } else {
                            document.getElementById('q-answer').style.display = 'none';
                        }
                    } else if (role === 'red' || role === 'green') {
                        document.getElementById('q-char-disp').innerText = q.char;
                        document.getElementById('q-text').innerText = "Ø§Ø³ØªÙ…Ø¹ Ù„Ø³Ø¤Ø§Ù„ Ø§Ù„Ù…Ù‚Ø¯Ù… ğŸ¤";
                        document.getElementById('admin-overlay-controls').style.display = 'none';
                        document.getElementById('admin-buzzer-status').style.display = 'none';
                        document.getElementById('q-answer').style.display = 'none';
                        document.getElementById('player-buzzer-area').style.display = 'block';
                        const btn = document.getElementById('buzzer-btn');
                        const msg = document.getElementById('buzzer-msg');
                        if(q.buzzer) {
                            btn.disabled = true; btn.style.opacity = "0.3";
                            if(q.buzzer === role) { msg.innerText = "ğŸ‰ Ù„Ùƒ Ø§Ù„Ø£Ø­Ù‚ÙŠØ©! Ø¬Ø§ÙˆØ¨"; msg.style.color = "#2ed573"; } 
                            else { msg.innerText = "ğŸ”’ Ø§Ù„ÙØ±ÙŠÙ‚ Ø§Ù„Ø¢Ø®Ø± Ø¶ØºØ· Ø£ÙˆÙ„Ø§Ù‹"; msg.style.color = "red"; }
                        } else {
                            btn.disabled = false; btn.style.opacity = "1"; msg.innerText = "";
                        }
                    } else {
                        overlay.style.display = 'none';
                    }
                } else {
                    overlay.style.display = 'none';
                }
            });
        }

        function initAdmin() {
            document.getElementById('scr-setup').classList.remove('active'); document.getElementById('scr-admin').classList.add('active');
            monitorQuestion();
            db.ref(`games/${roomId}`).on('value', s => {
                const d = s.val(); if(!d) return;
                
                // Ø­ÙØ¸ Ø§Ù„Ø£Ø³Ù…Ø§Ø¡ Ù„Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ù…Ø­Ù„ÙŠ
                team1Name = d.t1;
                team2Name = d.t2;
                
                // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø£Ø²Ø±Ø§Ø± ÙÙŠ Ù…ÙˆØ¯Ø§Ù„ Ø§Ù„Ø£Ø¯Ù…Ù†
                document.getElementById('btn-win-red').innerText = d.t1;
                document.getElementById('btn-win-green').innerText = d.t2;
                document.getElementById('adm-rev-t1').innerText = d.t1 + ":";
                document.getElementById('adm-rev-t2').innerText = d.t2 + ":";

                if(d.state === 'reset') { window.location.href = window.location.pathname; return; }

                if(d.state === 1) {
                    const grid = document.getElementById('admin-grid'); grid.innerHTML = '';
                    d.letters.forEach((l, i) => {
                        const div = document.createElement('div'); div.className = `letter-box ${d.colors?.[i] || ''}`; div.innerText = l;
                        div.onclick = () => openAdminModal(i, l); grid.appendChild(div);
                    });
                } else if(d.state === 2) {
                    document.getElementById('admin-pre-game').style.display = 'none';
                    document.getElementById('admin-p1').style.display = 'none'; document.getElementById('admin-p2').style.display = 'block';
                } else if(d.state === 3) {
                    document.getElementById('admin-p2').style.display = 'none'; document.getElementById('admin-p3').style.display = 'block';
                    renderReviewPanel(d);
                }
            });
        }
        function renderReviewPanel(d) {
            const rChars = document.getElementById('review-chars-red'); const gChars = document.getElementById('review-chars-green');
            rChars.innerHTML = ''; gChars.innerHTML = '';
            d.letters.forEach((l, i) => {
                if(d.colors?.[i] === 'red') rChars.innerHTML += `<div class="tiny-letter">${l}</div>`;
                if(d.colors?.[i] === 'green') gChars.innerHTML += `<div class="tiny-letter">${l}</div>`;
            });
            const rList = document.getElementById('review-list-red'); const gList = document.getElementById('review-list-green');
            rList.innerHTML = ''; gList.innerHTML = '';
            if(d.words && d.words.red) Object.entries(d.words.red).forEach(([key, val]) => {
                rList.innerHTML += `<div class="res-word ${val.status === 'ok'?'approved':'rejected'}">${val.text}<div><button class="judge-btn btn-ok" onclick="judgeWord('red','${key}','ok')">âœ”</button><button class="judge-btn btn-no" onclick="judgeWord('red','${key}','bad')">âœ–</button></div></div>`;
            });
            if(d.words && d.words.green) Object.entries(d.words.green).forEach(([key, val]) => {
                gList.innerHTML += `<div class="res-word ${val.status === 'ok'?'approved':'rejected'}">${val.text}<div><button class="judge-btn btn-ok" onclick="judgeWord('green','${key}','ok')">âœ”</button><button class="judge-btn btn-no" onclick="judgeWord('green','${key}','bad')">âœ–</button></div></div>`;
            });
        }
        function judgeWord(team, key, status) { db.ref(`games/${roomId}/words/${team}/${key}/status`).set(status); }
        function publishResults() { if(confirm("Ù†Ø´Ø± Ø§Ù„Ù†ØªØ§Ø¦Ø¬ØŸ")) db.ref(`games/${roomId}/state`).set(4); }
        
        function openAdminModal(i, char) {
            selIdx = i; document.getElementById('adm-modal-char').innerText = char;
            document.getElementById('admin-modal').style.display = 'flex';
            const qData = questionsDB[char] || {easy:{q:"?",a:"?"}, medium:{q:"?",a:"?"}, hard:{q:"?",a:"?"}};
            const container = document.getElementById('admin-q-selection');
            container.innerHTML = `
                <button class="q-select-btn" style="background:#00e676" onclick="triggerQuestion('easy', '${char}')">Ø³Ù‡Ù„: ${qData.easy.q}</button>
                <button class="q-select-btn" style="background:#ff9800" onclick="triggerQuestion('medium', '${char}')">Ù…ØªÙˆØ³Ø·: ${qData.medium.q}</button>
                <button class="q-select-btn" style="background:#f44336" onclick="triggerQuestion('hard', '${char}')">ØµØ¹Ø¨: ${qData.hard.q}</button>
            `;
        }
        function triggerQuestion(diff, char) {
            const qData = questionsDB[char][diff];
            db.ref(`games/${roomId}/activeQ`).set({ visible: true, char: char, text: qData.q, answer: qData.a, showAns: false, buzzer: null });
            document.getElementById('admin-modal').style.display = 'none';
        }
        function resetBuzzer() { db.ref(`games/${roomId}/activeQ/buzzer`).set(null); }
        function toggleAnswer() { db.ref(`games/${roomId}/activeQ/showAns`).transaction(v => !v); }
        function hideQuestionAndReturn() { db.ref(`games/${roomId}/activeQ`).set(null); document.getElementById('admin-modal').style.display = 'flex'; }
        function colorChar(c) { db.ref(`games/${roomId}/colors/${selIdx}`).set(c); document.getElementById('admin-modal').style.display = 'none'; }
        function closeAdminModal() { document.getElementById('admin-modal').style.display = 'none'; }
        function setPhase(p) { if(confirm("ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø§Ù†ØªÙ‚Ø§Ù„ØŸ")) db.ref(`games/${roomId}/state`).set(p); }
        function startTimer() {
            const mins = document.getElementById('custom-timer-input').value || 2; let t = mins * 60;
            let int = setInterval(() => { t--; db.ref(`games/${roomId}/timer`).set(t); if(t <= 0) { clearInterval(int); stopTimer(); } }, 1000);
        }
        function stopTimer() { db.ref(`games/${roomId}/timer`).set(-1); db.ref(`games/${roomId}/state`).set(3); }

        function initPlayer() {
            document.getElementById('scr-setup').classList.remove('active'); document.getElementById('scr-player').classList.add('active');
            monitorQuestion();
            // Ù‡Ù†Ø§ Ù„Ø§ Ù†Ø³ØªØ·ÙŠØ¹ Ù…Ø¹Ø±ÙØ© Ø§Ù„Ø§Ø³Ù… ÙÙˆØ±Ø§Ù‹ Ù„Ø£Ù† Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù… ØªØµÙ„ Ø¨Ø¹Ø¯ØŒ Ø³Ù†Ø¹ØªÙ…Ø¯ Ø¹Ù„Ù‰ Ø§Ù„ØªØ­Ø¯ÙŠØ« ÙÙŠ listener
            db.ref(`games/${roomId}`).on('value', s => {
                const d = s.val(); if(!d) return;
                
                // Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ø¶Ø¨Ø·
                if(d.state === 'reset') { window.location.href = window.location.pathname; return; }

                // ØªØ­Ø¯ÙŠØ« Ø§Ø³Ù… Ø§Ù„ÙØ±ÙŠÙ‚
                if(role === 'red') {
                    document.getElementById('p-team-name').innerText = d.t1;
                    document.getElementById('p-team-name').style.color = "var(--red)";
                } else {
                    document.getElementById('p-team-name').innerText = d.t2;
                    document.getElementById('p-team-name').style.color = "var(--green)";
                }

                let myL = []; d.letters.forEach((l, i) => { if(d.colors?.[i] === role) myL.push(l); });
                const html = myL.map(l => `<div class="tiny-letter">${l}</div>`).join('');
                document.getElementById('p-letters').innerHTML = html || "Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø­Ø±ÙˆÙ";
                document.getElementById('p-letters-2').innerHTML = html;
                if(d.state === 2) { document.getElementById('p-p1').style.display = 'none'; document.getElementById('p-p2').style.display = 'block'; }
                else if(d.state >= 3) { document.getElementById('p-p2').style.display = 'none'; document.getElementById('p-p3').style.display = 'block'; }
            });
        }
        function sendWord() {
            const w = document.getElementById('word-in').value;
            if(w) { db.ref(`games/${roomId}/words/${role}`).push({ text: w, status: 'ok' }); document.getElementById('word-in').value = ''; document.getElementById('sent-msg').innerText = "ØªÙ… Ø§Ù„Ø¥Ø±Ø³Ø§Ù„!"; setTimeout(()=>document.getElementById('sent-msg').innerText='', 1500); }
        }
        function hitBuzzer() {
            db.ref(`games/${roomId}/activeQ/buzzer`).transaction((currentVal) => {
                if (currentVal === null) { return role; } else { return; } 
            });
        }
    </script>
</body>
</html>